============================= test session starts ==============================
platform darwin -- Python 3.11.14, pytest-9.0.1, pluggy-1.6.0 -- /Users/arustydev/repos/mcp/zettelkasten-mcp/.venv/bin/python3
cachedir: .pytest_cache
rootdir: /Users/arustydev/repos/mcp/zettelkasten-mcp
configfile: pyproject.toml
testpaths: tests
plugins: anyio-4.11.0, asyncio-1.3.0, cov-7.0.0
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 130 items

tests/test_health_check.py::TestHealthCheck::test_health_check_returns_healthy_status SKIPPED [  0%]
tests/test_health_check.py::TestHealthCheck::test_health_check_endpoint_accessible FAILED [  1%]
tests/test_health_check.py::TestHealthCheck::test_health_check_with_cors FAILED [  2%]
tests/test_health_check.py::TestHealthCheck::test_http_server_includes_health_endpoint PASSED [  3%]
tests/test_http_cli.py::TestHTTPCLI::test_default_transport_is_stdio PASSED [  3%]
tests/test_http_cli.py::TestHTTPCLI::test_http_transport_argument PASSED [  4%]
tests/test_http_cli.py::TestHTTPCLI::test_stdio_transport_explicit PASSED [  5%]
tests/test_http_cli.py::TestHTTPCLI::test_host_argument PASSED           [  6%]
tests/test_http_cli.py::TestHTTPCLI::test_port_argument PASSED           [  6%]
tests/test_http_cli.py::TestHTTPCLI::test_port_argument_type PASSED      [  7%]
tests/test_http_cli.py::TestHTTPCLI::test_cors_flag PASSED               [  8%]
tests/test_http_cli.py::TestHTTPCLI::test_cors_default_is_none PASSED    [  9%]
tests/test_http_cli.py::TestHTTPCLI::test_combined_http_arguments PASSED [ 10%]
tests/test_http_cli.py::TestHTTPCLI::test_host_without_transport PASSED  [ 10%]
tests/test_http_cli.py::TestHTTPCLI::test_port_without_transport PASSED  [ 11%]
tests/test_http_cli.py::TestHTTPCLI::test_invalid_transport_raises_error PASSED [ 12%]
tests/test_http_cli.py::TestHTTPCLI::test_invalid_port_raises_error PASSED [ 13%]
tests/test_http_cli.py::TestHTTPCLI::test_log_level_argument PASSED      [ 13%]
tests/test_http_cli.py::TestHTTPCLI::test_all_arguments_together PASSED  [ 14%]
tests/test_http_cli.py::TestHTTPCLI::test_cli_port_overrides_env_var PASSED [ 15%]
tests/test_http_cli.py::TestHTTPCLI::test_env_var_used_when_no_cli_port PASSED [ 16%]
tests/test_http_cli.py::TestHTTPCLI::test_help_flag PASSED               [ 16%]
tests/test_http_cli.py::TestHTTPCLI::test_notes_dir_argument PASSED      [ 17%]
tests/test_http_cli.py::TestHTTPCLI::test_database_path_argument PASSED  [ 18%]
tests/test_http_config.py::TestHTTPConfiguration::test_default_http_config_values PASSED [ 19%]
tests/test_http_config.py::TestHTTPConfiguration::test_http_host_from_env SKIPPED [ 20%]
tests/test_http_config.py::TestHTTPConfiguration::test_http_port_from_env SKIPPED [ 20%]
tests/test_http_config.py::TestHTTPConfiguration::test_cors_enabled_from_env_true SKIPPED [ 21%]
tests/test_http_config.py::TestHTTPConfiguration::test_cors_enabled_from_env_false SKIPPED [ 22%]
tests/test_http_config.py::TestHTTPConfiguration::test_cors_enabled_case_insensitive SKIPPED [ 23%]
tests/test_http_config.py::TestHTTPConfiguration::test_cors_origins_single_from_env SKIPPED [ 23%]
tests/test_http_config.py::TestHTTPConfiguration::test_cors_origins_multiple_from_env SKIPPED [ 24%]
tests/test_http_config.py::TestHTTPConfiguration::test_cors_origins_with_spaces SKIPPED [ 25%]
tests/test_http_config.py::TestHTTPConfiguration::test_json_response_from_env_true SKIPPED [ 26%]
tests/test_http_config.py::TestHTTPConfiguration::test_json_response_from_env_false SKIPPED [ 26%]
tests/test_http_config.py::TestHTTPConfiguration::test_json_response_case_insensitive SKIPPED [ 27%]
tests/test_http_config.py::TestHTTPConfiguration::test_multiple_http_config_from_env SKIPPED [ 28%]
tests/test_http_config.py::TestHTTPConfiguration::test_http_port_invalid_value_raises_error SKIPPED [ 29%]
tests/test_http_config.py::TestHTTPConfiguration::test_server_name_persists_with_http_config SKIPPED [ 30%]
tests/test_http_transport.py::TestHTTPTransport::test_server_initializes_with_json_response PASSED [ 30%]
tests/test_http_transport.py::TestHTTPTransport::test_stdio_transport_selected_by_default PASSED [ 31%]
tests/test_http_transport.py::TestHTTPTransport::test_http_transport_with_default_port SKIPPED [ 32%]
tests/test_http_transport.py::TestHTTPTransport::test_http_transport_with_custom_port SKIPPED [ 33%]
tests/test_http_transport.py::TestHTTPTransport::test_http_transport_with_custom_host SKIPPED [ 33%]
tests/test_http_transport.py::TestHTTPTransport::test_http_transport_with_custom_host_and_port SKIPPED [ 34%]
tests/test_http_transport.py::TestHTTPTransport::test_cors_middleware_not_applied_by_default SKIPPED [ 35%]
tests/test_http_transport.py::TestHTTPTransport::test_cors_middleware_applied_when_enabled SKIPPED [ 36%]
tests/test_http_transport.py::TestHTTPTransport::test_cors_origins_configuration SKIPPED [ 36%]
tests/test_http_transport.py::TestHTTPTransport::test_cors_middleware_configuration SKIPPED [ 37%]
tests/test_http_transport.py::TestHTTPTransport::test_sse_app_method_called_for_http SKIPPED [ 38%]
tests/test_http_transport.py::TestHTTPTransport::test_http_logging_without_cors SKIPPED [ 39%]
tests/test_http_transport.py::TestHTTPTransport::test_http_logging_with_cors SKIPPED [ 40%]
tests/test_http_transport.py::TestHTTPTransport::test_stdio_logging PASSED [ 40%]
tests/test_integration.py::TestIntegration::test_create_note_flow PASSED [ 41%]
tests/test_integration.py::TestIntegration::test_knowledge_graph_flow PASSED [ 42%]
tests/test_integration.py::TestIntegration::test_rebuild_index_flow PASSED [ 43%]
tests/test_mcp_server.py::TestMcpServer::test_server_initialization PASSED [ 43%]
tests/test_mcp_server.py::TestMcpServer::test_create_note_tool PASSED    [ 44%]
tests/test_mcp_server.py::TestMcpServer::test_get_note_tool PASSED       [ 45%]
tests/test_mcp_server.py::TestMcpServer::test_create_link_tool PASSED    [ 46%]
tests/test_mcp_server.py::TestMcpServer::test_search_notes_tool PASSED   [ 46%]
tests/test_mcp_server.py::TestMcpServer::test_error_handling PASSED      [ 47%]
tests/test_models.py::TestNoteModel::test_note_creation PASSED           [ 48%]
tests/test_models.py::TestNoteModel::test_note_validation PASSED         [ 49%]
tests/test_models.py::TestNoteModel::test_note_tag_operations PASSED     [ 50%]
tests/test_models.py::TestNoteModel::test_note_link_operations PASSED    [ 50%]
tests/test_models.py::TestNoteModel::test_note_to_markdown PASSED        [ 51%]
tests/test_models.py::TestLinkModel::test_link_creation PASSED           [ 52%]
tests/test_models.py::TestLinkModel::test_link_validation PASSED         [ 53%]
tests/test_models.py::TestLinkModel::test_link_immutability PASSED       [ 53%]
tests/test_models.py::TestTagModel::test_tag_creation PASSED             [ 54%]
tests/test_models.py::TestTagModel::test_tag_immutability PASSED         [ 55%]
tests/test_models.py::TestHelperFunctions::test_iso8601_id_format PASSED [ 56%]
tests/test_models.py::TestHelperFunctions::test_iso8601_uniqueness PASSED [ 56%]
tests/test_models.py::TestHelperFunctions::test_iso8601_chronological_sorting PASSED [ 57%]
tests/test_note_repository.py::test_create_note PASSED                   [ 58%]
tests/test_note_repository.py::test_get_note PASSED                      [ 59%]
tests/test_note_repository.py::test_update_note PASSED                   [ 60%]
tests/test_note_repository.py::test_delete_note PASSED                   [ 60%]
tests/test_note_repository.py::test_search_notes PASSED                  [ 61%]
tests/test_note_repository.py::test_note_linking PASSED                  [ 62%]
tests/test_search_service.py::TestSearchService::test_search_by_text PASSED [ 63%]
tests/test_search_service.py::TestSearchService::test_search_by_tag PASSED [ 63%]
tests/test_search_service.py::TestSearchService::test_search_by_link PASSED [ 64%]
tests/test_search_service.py::TestSearchService::test_find_orphaned_notes PASSED [ 65%]
tests/test_search_service.py::TestSearchService::test_find_central_notes PASSED [ 66%]
tests/test_search_service.py::TestSearchService::test_find_notes_by_date_range PASSED [ 66%]
tests/test_search_service.py::TestSearchService::test_find_similar_notes PASSED [ 67%]
tests/test_search_service.py::TestSearchService::test_search_combined PASSED [ 68%]
tests/test_semantic_links.py::TestSemanticLinks::test_all_link_types_creation PASSED [ 69%]
tests/test_semantic_links.py::TestSemanticLinks::test_bidirectional_semantic_links PASSED [ 70%]
tests/test_semantic_links.py::TestSemanticLinks::test_custom_bidirectional_link_types PASSED [ 70%]
tests/test_semantic_links.py::TestSemanticLinks::test_links_persistence_through_save_and_load PASSED [ 71%]
tests/test_semantic_links.py::TestSemanticLinks::test_multiple_link_types_between_notes PASSED [ 72%]
tests/test_semantic_links.py::TestSemanticLinks::test_updating_link PASSED [ 73%]
tests/test_semantic_links.py::TestSemanticLinks::test_removing_links PASSED [ 73%]
tests/test_semantic_links.py::TestSemanticLinks::test_bidirectional_link_removal PASSED [ 74%]
tests/test_semantic_links.py::TestSemanticLinks::test_parsing_link_types_from_markdown PASSED [ 75%]
tests/test_semantic_links.py::TestSemanticLinks::test_markdown_generation_with_links PASSED [ 76%]
tests/test_semantic_links.py::TestSemanticLinks::test_link_type_uniqueness_constraint PASSED [ 76%]
tests/test_semantic_links.py::TestSemanticLinks::test_get_linked_notes_outgoing PASSED [ 77%]
tests/test_semantic_links.py::TestSemanticLinks::test_mcp_get_linked_notes_tool PASSED [ 78%]
tests/test_semantic_links.py::TestSemanticLinks::test_mcp_create_link_tool PASSED [ 79%]
tests/test_semantic_links.py::TestSemanticLinks::test_link_cycle_detection PASSED [ 80%]
tests/test_semantic_links.py::TestSemanticLinks::test_semantic_links_in_search_results PASSED [ 80%]
tests/test_semantic_links.py::TestSemanticLinks::test_find_similar_notes_with_semantic_links PASSED [ 81%]
tests/test_semantic_links.py::TestSemanticLinks::test_central_notes_with_semantic_links PASSED [ 82%]
tests/test_stdio_regression.py::TestSTDIORegression::test_server_initialization_creates_all_services PASSED [ 83%]
tests/test_stdio_regression.py::TestSTDIORegression::test_stdio_transport_default_behavior PASSED [ 83%]
tests/test_stdio_regression.py::TestSTDIORegression::test_stdio_transport_explicit PASSED [ 84%]
tests/test_stdio_regression.py::TestSTDIORegression::test_http_dependencies_lazy_loaded_for_stdio SKIPPED [ 85%]
tests/test_stdio_regression.py::TestSTDIORegression::test_cors_middleware_not_imported_for_stdio PASSED [ 86%]
tests/test_stdio_regression.py::TestSTDIORegression::test_all_mcp_tools_registered PASSED [ 86%]
tests/test_stdio_regression.py::TestSTDIORegression::test_server_initialization_with_default_config PASSED [ 87%]
tests/test_stdio_regression.py::TestSTDIORegression::test_no_http_parameters_affect_stdio PASSED [ 88%]
tests/test_stdio_regression.py::TestSTDIORegression::test_sse_app_not_called_for_stdio PASSED [ 89%]
tests/test_stdio_regression.py::TestSTDIORegression::test_stdio_logging_message PASSED [ 90%]
tests/test_stdio_regression.py::TestSTDIORegression::test_zettel_service_initialization PASSED [ 90%]
tests/test_stdio_regression.py::TestSTDIORegression::test_search_service_initialization PASSED [ 91%]
tests/test_stdio_regression.py::TestSTDIORegression::test_fastmcp_json_response_parameter PASSED [ 92%]
tests/test_stdio_regression.py::TestSTDIORegression::test_multiple_stdio_runs_without_http PASSED [ 93%]
tests/test_stdio_regression.py::TestSTDIORegression::test_config_values_not_changed_by_http_additions PASSED [ 93%]
tests/test_stdio_regression.py::TestSTDIORegression::test_backward_compatibility_with_existing_code PASSED [ 94%]
tests/test_zettel_service.py::test_create_note PASSED                    [ 95%]
tests/test_zettel_service.py::test_get_note PASSED                       [ 96%]
tests/test_zettel_service.py::test_update_note PASSED                    [ 96%]
tests/test_zettel_service.py::test_delete_note PASSED                    [ 97%]
tests/test_zettel_service.py::test_create_link PASSED                    [ 98%]
tests/test_zettel_service.py::test_search_notes PASSED                   [ 99%]
tests/test_zettel_service.py::test_find_similar_notes PASSED             [100%]

=================================== FAILURES ===================================
____________ TestHealthCheck.test_health_check_endpoint_accessible _____________

self = <test_health_check.TestHealthCheck object at 0x10d3fc6d0>

    def test_health_check_endpoint_accessible(self):
        """Test that /health endpoint is accessible in wrapped app."""
        from starlette.testclient import TestClient
    
        # Create a mock MCP app
        mock_mcp_app = Mock()
    
        # Wrap with health check
        app = create_app_with_health(mock_mcp_app)
    
        # Test the endpoint
        client = TestClient(app)
        response = client.get("/health")
    
        assert response.status_code == 200
>       assert response.json() == {
            "status": "healthy",
            "service": "zettelkasten-mcp",
            "transport": "http"
        }
E       AssertionError: assert {'service': '...eamable-http'} == {'service': '...port': 'http'}
E         
E         Omitting 2 identical items, use -vv to show
E         Differing items:
E         {'transport': 'streamable-http'} != {'transport': 'http'}
E         
E         Full diff:
E           {...
E         
E         ...Full output truncated (6 lines hidden), use '-vv' to show

tests/test_health_check.py:38: AssertionError
_________________ TestHealthCheck.test_health_check_with_cors __________________

self = <test_health_check.TestHealthCheck object at 0x10d3fcbd0>

    def test_health_check_with_cors(self):
        """Test that health check works with CORS enabled."""
        from starlette.testclient import TestClient
        from starlette.middleware.cors import CORSMiddleware
    
        # Create a mock MCP app
        mock_mcp_app = Mock()
    
        # Wrap with health check
        app = create_app_with_health(mock_mcp_app)
    
        # Add CORS middleware
        app = CORSMiddleware(
            app,
            allow_origins=["*"],
            allow_methods=["GET", "POST", "OPTIONS"],
            allow_headers=["*"],
            expose_headers=["Mcp-Session-Id"],
        )
    
        # Test the endpoint with CORS
        client = TestClient(app)
        response = client.get(
            "/health",
            headers={"Origin": "https://example.com"}
        )
    
        assert response.status_code == 200
>       assert response.json() == {
            "status": "healthy",
            "service": "zettelkasten-mcp",
            "transport": "http"
        }
E       AssertionError: assert {'service': '...eamable-http'} == {'service': '...port': 'http'}
E         
E         Omitting 2 identical items, use -vv to show
E         Differing items:
E         {'transport': 'streamable-http'} != {'transport': 'http'}
E         
E         Full diff:
E           {...
E         
E         ...Full output truncated (6 lines hidden), use '-vv' to show

tests/test_health_check.py:72: AssertionError
=========================== short test summary info ============================
FAILED tests/test_health_check.py::TestHealthCheck::test_health_check_endpoint_accessible
FAILED tests/test_health_check.py::TestHealthCheck::test_health_check_with_cors
================== 2 failed, 101 passed, 27 skipped in 1.02s ===================
